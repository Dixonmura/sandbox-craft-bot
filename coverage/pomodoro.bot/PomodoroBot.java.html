<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PomodoroBot.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Java TelegramAPI Module</a> &gt; <a href="index.source.html" class="el_package">pomodoro.bot</a> &gt; <span class="el_source">PomodoroBot.java</span></div><h1>PomodoroBot.java</h1><pre class="source lang-java linenums">package pomodoro.bot;

import bot.utils.CsvResourceReader;
import bot.utils.CsvStatsReader;
import bot.utils.StatsUtils;
import bot.utils.StatsWriter;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.telegram.telegrambots.meta.api.objects.Update;
import pomodoro.core.*;
import pomodoro.service.PomodoroManager;
import pomodoro.service.StatsLogger;

import java.io.IOException;
import java.io.InputStream;
import java.io.UncheckedIOException;
import java.nio.file.Path;
import java.time.Clock;
import java.time.Duration;
import java.time.Instant;
import java.util.*;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.ScheduledFuture;
import java.util.concurrent.TimeUnit;

/**
 * –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –±–æ—Ç–∞-Pomodoro.
 * –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ–º–∞–Ω–¥–∞–º–∏ –Ω–∞—á–∞–ª–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
 * –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤, –≤—ã–≤–æ–¥–æ–º –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
 */
public class PomodoroBot {

<span class="fc" id="L34">    private static final Logger log = LogManager.getLogger(PomodoroBot.class);</span>
    private final ScheduledExecutorService scheduled;
    private final Map&lt;Long, UserSetupState&gt; stateUsers;
    private final PomodoroSender sender;
    private final StatsLogger statsLogger;
    private final CsvResourceReader reader;
    private final CsvStatsReader csvStatsReader;
<span class="fc" id="L41">    private Map&lt;Phase, List&lt;MotivationPhoto&gt;&gt; motivationPhotos = new HashMap&lt;&gt;();</span>
<span class="fc" id="L42">    private PomodoroManager pomodoroManager = null;</span>
    private PomodoroStats stats;
    private final StatsUtils statsUtils;

<span class="fc" id="L46">    public PomodoroBot(PomodoroSender sender) {</span>
<span class="fc" id="L47">        reader = new CsvResourceReader();</span>
<span class="fc" id="L48">        try (InputStream is = getClass()</span>
<span class="fc" id="L49">                .getClassLoader()</span>
<span class="fc" id="L50">                .getResourceAsStream(&quot;assets/motivations/motivations.csv&quot;)) {</span>

<span class="fc" id="L52">            List&lt;MotivationPhoto&gt; photos = reader.read(is, ',', row -&gt; new MotivationPhoto(row[0], row[1]));</span>
<span class="fc" id="L53">            List&lt;MotivationPhoto&gt; photosForWork = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L54">            List&lt;MotivationPhoto&gt; photosForRest = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L56">            photos.forEach(photo -&gt; {</span>

<span class="fc bfc" id="L58" title="All 2 branches covered.">                if (photo.motivationTitle().startsWith(&quot;work&quot;)) {</span>
<span class="fc" id="L59">                    photosForWork.add(photo);</span>
                } else {
<span class="fc" id="L61">                    photosForRest.add(photo);</span>
                }
<span class="fc" id="L63">            });</span>
<span class="fc" id="L64">            motivationPhotos.put(Phase.WORK, photosForWork);</span>
<span class="fc" id="L65">            motivationPhotos.put(Phase.SHORT_BREAK, photosForRest);</span>
<span class="fc" id="L66">            motivationPhotos.put(Phase.LONG_BREAK, photosForRest);</span>
<span class="fc" id="L67">            this.motivationPhotos = Collections.unmodifiableMap(motivationPhotos);</span>
<span class="nc" id="L68">        } catch (IOException e) {</span>
<span class="nc" id="L69">            log.error(&quot;–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª movies.csv&quot;, e);</span>
<span class="nc" id="L70">            throw new UncheckedIOException(e);</span>
<span class="fc" id="L71">        }</span>
<span class="fc" id="L72">        this.sender = sender;</span>
<span class="fc" id="L73">        stateUsers = new HashMap&lt;&gt;();</span>
<span class="fc" id="L74">        pomodoroManager = new PomodoroManager(motivationPhotos);</span>
<span class="fc" id="L75">        scheduled = Executors.newScheduledThreadPool(4);</span>
<span class="fc" id="L76">        StatsWriter writer = new StatsWriter();</span>
<span class="fc" id="L77">        statsLogger = new StatsLogger(writer, Path.of(&quot;Telegram_API/logs&quot;));</span>
<span class="fc" id="L78">        csvStatsReader = new CsvStatsReader(Path.of(&quot;Telegram_API/logs&quot;), Clock.systemDefaultZone(), reader);</span>
<span class="fc" id="L79">        statsUtils = new StatsUtils();</span>
<span class="fc" id="L80">    }</span>

    /**
     * –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
     *
     * @param update –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Telegram
     * @return –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—á–µ–≥–æ —Ü–∏–∫–ª–∞
     */
    public PomodoroReply startPomodoro(Update update) {
<span class="fc" id="L89">        Long chatId = update.getMessage().getChatId();</span>
<span class="fc" id="L90">        UserSetupState state = new UserSetupState();</span>
<span class="fc" id="L91">        state.setStep(SetupStep.WAITING_WORK_DURATION);</span>
<span class="fc" id="L92">        stateUsers.put(chatId, state);</span>

<span class="fc" id="L94">        String text = &quot;&quot;&quot;</span>
                –ú–µ—Ç–æ–¥ ¬´–ü–æ–º–æ–¥–æ—Ä–æ¬ª ‚Äî —ç—Ç–æ —Ä–∞–±–æ—Ç–∞ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Ä—ã–≤–∫–∞–º–∏ —Å –ø–∞—É–∑–∞–º–∏ üçÖ
                –û–¥–∏–Ω ¬´–ø–æ–º–∏–¥–æ—Ä¬ª = —Å–Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç–∞, –ø–æ—Ç–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–¥—ã—Ö ‚Äî —Ç–∞–∫ –ª–µ–≥—á–µ –Ω–µ –≤—ã–≥–æ—Ä–µ—Ç—å –∏ –Ω–µ –∑–∞–ª–∏–ø–∞—Ç—å –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ üí™
                
                –ö–∞–∫ –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å:
                1Ô∏è‚É£ –¢—ã –∑–∞–¥–∞—ë—à—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—á–µ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
                2Ô∏è‚É£ –Ø –∑–∞–ø—É—Å–∫–∞—é —Ç–∞–π–º–µ—Ä –∏ –Ω–∞–ø–æ–º–Ω—é, –∫–æ–≥–¥–∞ –ø–æ—Ä–∞ –æ—Ç–¥—ã—Ö–∞—Ç—å ‚è±Ô∏è
                3Ô∏è‚É£ –ó–∞ –∫–∞–∂–¥—ã–π –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –ø–æ–º–∏–¥–æ—Ä —Ç—ã –∫–æ–ø–∏—à—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –ø–æ–ª—É—á–∞–µ—à—å –∑–≤–∞–Ω–∏—è üèÖ
                
                –ù–∞–ø–∏—à–∏, –Ω–∞ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ä–∞–±–æ—á–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—É, —á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0Ô∏è‚É£).
                &quot;&quot;&quot;;

<span class="fc" id="L106">        log.info(&quot;–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ Pomodoro-–±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è chatId={}&quot;, chatId);</span>

<span class="fc" id="L108">        pomodoroManager.addSession(chatId, new PomodoroSession(</span>
                Phase.WORK,
<span class="fc" id="L110">                Duration.ofMinutes(25)));</span>

<span class="fc" id="L112">        return new PomodoroReply(text, null, true);</span>
    }

    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
     */
    public PomodoroReply handleAnswer(Update update) {

<span class="fc" id="L120">        Long chatId = update.getMessage().getChatId();</span>
<span class="fc" id="L121">        StringBuilder builder = new StringBuilder();</span>

<span class="fc bfc" id="L123" title="All 2 branches covered.">        if (pomodoroManager.getSession(chatId).getState().equals(SessionState.SETUP)) {</span>
<span class="fc" id="L124">            return checkUserSetupState(update, chatId);</span>
        }

<span class="pc bpc" id="L127" title="2 of 4 branches missed.">        if (!update.hasMessage() || !update.getMessage().hasText()) {</span>
<span class="nc" id="L128">            return new PomodoroReply(&quot;–ù–µ –ø–æ–Ω—è–ª —Å–æ–æ–±—â–µ–Ω–∏–µ \uD83E\uDD14\n&quot; +</span>
                    &quot;–î–ª—è –Ω—É–∂–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –Ω–∏–∂–µ ‚¨á\uFE0F&quot;,
                    null, false);
        } else {
<span class="fc" id="L132">            String textMessage = update.getMessage().getText();</span>
<span class="fc" id="L133">            PomodoroServiceSettings settings = pomodoroManager.getSettings(chatId);</span>

<span class="fc bfc" id="L135" title="All 2 branches covered.">            if (textMessage.equalsIgnoreCase(&quot;–°—Ç–∞—Ä—Ç \uD83D\uDE80&quot;)) {</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">                if (pomodoroManager.getSession(chatId).getState().equals(SessionState.WAITING)) {</span>
<span class="fc" id="L137">                    pomodoroManager.startWorkSession(chatId, settings.workDuration());</span>
<span class="fc" id="L138">                    sender.sendPomodoroReply(chatId, new PomodoroReply(</span>
                            &quot;–û—Ç–ª–∏—á–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π! –û—Ç—Å—á–µ—Ç –ø–æ—à–µ–ª! ‚è±\uFE0F&quot;,
<span class="fc" id="L140">                            pomodoroManager.chooseMotivationForSession(pomodoroManager.getSession(chatId)).pathToPhoto(),</span>
                            false));
<span class="fc" id="L142">                    pomodoroManager.getSession(chatId).setState(SessionState.RUNNING);</span>
<span class="fc" id="L143">                    scheduledPhaseEnd(chatId, settings.workDuration());</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">                } else if (pomodoroManager.getSession(chatId).getState().equals(SessionState.RUNNING)) {</span>
<span class="fc" id="L145">                    sender.sendPomodoroReply(chatId, new PomodoroReply(</span>
                            &quot;–¢—Å—Å—Å‚Ä¶ —Å–µ—Å—Å–∏—è —É–∂–µ –∏–¥—ë—Ç \uD83E\uDD2B\n&quot; +
                                    &quot;–ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ü–∏–∫–ª–∞ ‚è≥&quot;,
                            null,
                            false));
                }
<span class="fc bfc" id="L151" title="All 2 branches covered.">            } else if (textMessage.equalsIgnoreCase(&quot;–ü–∞—É–∑–∞ ‚è∏\uFE0F&quot;)) {</span>
<span class="fc" id="L152">                pomodoroManager.cancelFuture(chatId);</span>
<span class="fc" id="L153">                pomodoroManager.getSession(chatId).setState(SessionState.WAITING);</span>
<span class="fc" id="L154">                sender.sendPomodoroReply(chatId, new PomodoroReply(&quot;–¢–µ–∫—É—â–∏–π —Ü–∏–∫–ª –æ—Ç–º–µ–Ω—ë–Ω ‚èπ\uFE0F&quot;, null, false));</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">            } else if (textMessage.equalsIgnoreCase(&quot;–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ–∞–Ω—Å ‚úÖ&quot;)) {</span>
<span class="fc" id="L156">                closingMessage(builder, chatId);</span>
<span class="fc" id="L157">                pomodoroManager.cancelFuture(chatId);</span>
<span class="fc" id="L158">                sender.sendPomodoroReply(chatId, new PomodoroReply(builder.toString(), null, true));</span>
<span class="fc" id="L159">                sender.sendFinalStatsQuestion(chatId, &quot;üìä –•–æ—Ç–∏—Ç–µ –≤—ã–≤–µ—Å—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π?&quot;);</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">            } else if (textMessage.equalsIgnoreCase(&quot;–î–∞ üìä&quot;)) {</span>
<span class="nc" id="L161">                stats = csvStatsReader.readMonthlyStats(chatId);</span>
<span class="nc" id="L162">                sender.sendPomodoroReply(chatId, new PomodoroReply(statsUtils.getStatsMessage(stats), null, true));</span>
<span class="nc" id="L163">                log.info(&quot;–ó–∞–≤–µ—Ä—à–µ–Ω–∞ —Å–µ—Å—Å–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è chatId={}&quot;, chatId);</span>
<span class="nc" id="L164">                pomodoroManager.endSession(chatId);</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">            } else if (textMessage.equalsIgnoreCase(&quot;–ù–µ—Ç ‚ùå&quot;)) {</span>
<span class="nc" id="L166">                sender.sendPomodoroReply(chatId, new PomodoroReply(statsUtils.getStatsMessage(stats), null, true));</span>
<span class="nc" id="L167">                log.info(&quot;–ó–∞–≤–µ—Ä—à–µ–Ω–∞ —Å–µ—Å—Å–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è chatId={}&quot;, chatId);</span>
<span class="nc" id="L168">                pomodoroManager.endSession(chatId);</span>
            }

<span class="fc" id="L171">            return new PomodoroReply(&quot;&quot;, null, false);</span>
        }
    }

    public void scheduledPhaseEnd(Long chatId, Duration duration) {
<span class="fc" id="L176">        ScheduledFuture&lt;?&gt; future = scheduled.schedule(</span>
<span class="nc" id="L177">                () -&gt; onPhaseFinished(chatId),</span>
<span class="fc" id="L178">                duration.toMinutes(),</span>
                TimeUnit.MINUTES
        );
<span class="fc" id="L181">        pomodoroManager.saveFuture(chatId, future);</span>
<span class="fc" id="L182">    }</span>

    private void onPhaseFinished(Long chatId) {
<span class="nc" id="L185">        PomodoroSession session = pomodoroManager.getSession(chatId);</span>
<span class="nc" id="L186">        PomodoroServiceSettings settings = pomodoroManager.getSettings(chatId);</span>
<span class="nc" id="L187">        StringBuilder builder = new StringBuilder();</span>

<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (pomodoroManager.isOverLimit(session)) {</span>
<span class="nc" id="L190">            log.info(&quot;–ó–∞–≤–µ—Ä—à–µ–Ω–∞ —Å–µ—Å—Å–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è chatId={}&quot;, chatId);</span>
<span class="nc" id="L191">            builder.append(&quot;–£–≤–∞–∂–∞–µ–º—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å–µ—Å—Å–∏—è –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –ª–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç–∞ ‚è≥\uD83D\uDEAA&quot;);</span>
<span class="nc" id="L192">            closingMessage(builder, chatId);</span>
<span class="nc" id="L193">            pomodoroManager.cancelFuture(chatId);</span>

<span class="nc" id="L195">            Phase currentPhase = pomodoroManager.getSession(chatId).getCurrentPhase();</span>
<span class="nc bnc" id="L196" title="All 3 branches missed.">            Duration currentDuration = switch (currentPhase) {</span>
<span class="nc" id="L197">                case WORK -&gt; settings.workDuration();</span>
<span class="nc" id="L198">                case SHORT_BREAK -&gt; settings.shortRestDuration();</span>
<span class="nc" id="L199">                case LONG_BREAK -&gt; settings.longRestDuration();</span>
            };
<span class="nc" id="L201">            statsLogger.logPhase(chatId, currentPhase, currentDuration, Instant.now());</span>
<span class="nc" id="L202">            session.completeCurrentPhase();</span>

<span class="nc" id="L204">            sender.sendPomodoroReply(chatId, new PomodoroReply(</span>
<span class="nc" id="L205">                    builder.toString(),</span>
<span class="nc" id="L206">                    pomodoroManager.chooseMotivationForSession(session).pathToPhoto(),</span>
                    true));
<span class="nc" id="L208">            pomodoroManager.endSession(chatId);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        } else if (!session.isWarnedAboutLimit() &amp;&amp;</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                pomodoroManager.isCloseToLimit(session, Duration.ofHours(2))) {</span>
<span class="nc" id="L211">            builder.append(&quot;–£–≤–∞–∂–∞–µ–º—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å –º–æ–º–µ–Ω—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–æ—à–ª–æ —É–∂–µ –±–æ–ª–µ–µ 14 —á–∞—Å–æ–≤ ‚è∞&quot;)</span>
<span class="nc" id="L212">                    .append(&quot;\n–í —Å–∫–æ—Ä–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å–µ—Å—Å–∏—è –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç–∞ –ø–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é –ª–∏–º–∏—Ç–∞ ‚è≥&quot;);</span>
<span class="nc" id="L213">            session.setWantedAboutLimit(true);</span>
<span class="nc" id="L214">            sender.sendPomodoroReply(chatId, new PomodoroReply(builder.toString(), null, false));</span>
        }

<span class="nc" id="L217">        Phase nextPhase = pomodoroManager.getNextPhase(session, chatId);</span>
<span class="nc bnc" id="L218" title="All 4 branches missed.">        switch (nextPhase) {</span>
            case SHORT_BREAK -&gt; {
<span class="nc bnc" id="L220" title="All 2 branches missed.">                if (session.isCurrentPhaseFinished()) {</span>
<span class="nc" id="L221">                    session.completeCurrentPhase();</span>
<span class="nc" id="L222">                    logCurrentPhase(chatId, settings);</span>
                }
<span class="nc" id="L224">                session.setCurrentPhase(Phase.SHORT_BREAK);</span>
<span class="nc" id="L225">                session.startCurrentPhase(settings.shortRestDuration());</span>
<span class="nc" id="L226">                sender.sendPomodoroReply(chatId, new PomodoroReply(</span>
                        &quot;–ü–æ—Ä–∞ —Å–¥–µ–ª–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤! \uD83E\uDDD8\u200D‚ôÇ\uFE0F‚òï&quot;,
<span class="nc" id="L228">                        pomodoroManager.chooseMotivationForSession(session).pathToPhoto(),</span>
                        false
                ));
<span class="nc" id="L231">                scheduledPhaseEnd(chatId, settings.shortRestDuration());</span>
<span class="nc" id="L232">            }</span>
            case LONG_BREAK -&gt; {
<span class="nc bnc" id="L234" title="All 2 branches missed.">                if (session.isCurrentPhaseFinished()) {</span>
<span class="nc" id="L235">                    session.completeCurrentPhase();</span>
<span class="nc" id="L236">                    logCurrentPhase(chatId, settings);</span>
                }
<span class="nc" id="L238">                session.setCurrentPhase(Phase.LONG_BREAK);</span>
<span class="nc" id="L239">                session.startCurrentPhase(settings.longRestDuration());</span>
<span class="nc" id="L240">                sender.sendPomodoroReply(chatId, new PomodoroReply(</span>
                        &quot;–ü–æ—Ä–∞ —Å–¥–µ–ª–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤! \uD83C\uDF34‚òï&quot;,
<span class="nc" id="L242">                        pomodoroManager.chooseMotivationForSession(session).pathToPhoto(),</span>
                        false
                ));
<span class="nc" id="L245">                scheduledPhaseEnd(chatId, settings.longRestDuration());</span>
<span class="nc" id="L246">            }</span>
            case WORK -&gt; {
<span class="nc bnc" id="L248" title="All 2 branches missed.">                if (session.isCurrentPhaseFinished()) {</span>
<span class="nc" id="L249">                    session.completeCurrentPhase();</span>
<span class="nc" id="L250">                    logCurrentPhase(chatId, settings);</span>
                }
<span class="nc" id="L252">                session.setCurrentPhase(Phase.WORK);</span>
<span class="nc" id="L253">                session.startCurrentPhase(settings.workDuration());</span>
<span class="nc" id="L254">                sender.sendPomodoroReply(chatId, new PomodoroReply(</span>
                        &quot;–ü–µ—Ä–µ—Ä—ã–≤ –æ–∫–æ–Ω—á–µ–Ω, –ø–æ–µ—Ö–∞–ª–∏ –¥–∞–ª—å—à–µ! \uD83D\uDCAA&quot;,
<span class="nc" id="L256">                        pomodoroManager.chooseMotivationForSession(session).pathToPhoto(),</span>
                        false
                ));
<span class="nc" id="L259">                scheduledPhaseEnd(chatId, settings.workDuration());</span>
            }
        }
<span class="nc" id="L262">    }</span>

    private PomodoroReply checkUserSetupState(Update update, Long chatId) {
<span class="fc" id="L265">        UserSetupState state = stateUsers.get(chatId);</span>
        int value;
        String textMessage;
<span class="fc" id="L268">        String textAnswer = &quot;&quot;;</span>

<span class="pc bpc" id="L270" title="2 of 4 branches missed.">        if (!update.hasMessage() || !update.getMessage().hasText()) {</span>
<span class="nc" id="L271">            return new PomodoroReply(&quot;–ö–∞–∂–µ—Ç—Å—è, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ \uD83E\uDD14\n&quot; +</span>
                    &quot;–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.&quot;, null, true);
        } else {
<span class="fc" id="L274">            textMessage = update.getMessage().getText().trim();</span>
            try {
<span class="fc" id="L276">                value = Integer.parseInt(textMessage);</span>
<span class="fc" id="L277">            } catch (NumberFormatException e) {</span>
<span class="fc" id="L278">                return new PomodoroReply(&quot;–ù—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, –±–æ–ª—å—à–µ 0\uFE0F‚É£ \uD83D\uDE42&quot;, null, true);</span>
<span class="fc" id="L279">            }</span>
<span class="fc bfc" id="L280" title="All 2 branches covered.">            if (value &lt;= 0) {</span>
<span class="fc" id="L281">                return new PomodoroReply(&quot;–ß–∏—Å–ª–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ \uD83D\uDD01&quot;, null, true);</span>
            }
        }

<span class="fc bfc" id="L285" title="All 2 branches covered.">        if (state.getStep().equals(SetupStep.WAITING_WORK_DURATION)) {</span>
<span class="fc" id="L286">            state.setWorkDuration(Duration.ofMinutes(value));</span>
<span class="fc" id="L287">            state.setStep(SetupStep.WAITING_SHORT_REST_DURATION);</span>
<span class="fc" id="L288">            return new PomodoroReply(&quot;–ü–µ—Ä–∏–æ–¥ —Ä–∞–±–æ—á–µ–≥–æ —Ü–∏–∫–ª–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω ‚úÖ\n&quot; +</span>
                    &quot;–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–∏–æ–¥ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö ‚è±\uFE0F&quot;,
                    null, true);
<span class="fc bfc" id="L291" title="All 2 branches covered.">        } else if (state.getStep().equals(SetupStep.WAITING_SHORT_REST_DURATION)) {</span>
<span class="fc" id="L292">            state.setShortRestDuration(Duration.ofMinutes(value));</span>
<span class="fc" id="L293">            state.setStep(SetupStep.WAITING_LONG_REST_DURATION);</span>
<span class="fc" id="L294">            return new PomodoroReply(&quot;–ü–µ—Ä–∏–æ–¥ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω ‚úÖ\n&quot; +</span>
                    &quot;–î–∞–ª–µ–µ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª–∏–Ω–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö ‚è±\uFE0F&quot;,
                    null, true);
<span class="fc bfc" id="L297" title="All 2 branches covered.">        } else if (state.getStep().equals(SetupStep.WAITING_LONG_REST_DURATION)) {</span>
<span class="fc" id="L298">            state.setLongRestDuration(Duration.ofMinutes(value));</span>
<span class="fc" id="L299">            state.setStep(SetupStep.WAITING_COUNT_CYCLES);</span>
<span class="fc" id="L300">            return new PomodoroReply(&quot;–ü–µ—Ä–∏–æ–¥ –¥–ª–∏–Ω–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω ‚úÖ\n&quot; +</span>
                    &quot;–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö —Ü–∏–∫–ª–æ–≤ –¥–æ –¥–ª–∏–Ω–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ \uD83D\uDD01&quot;,
                    null, true);
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">        } else if (state.getStep().equals(SetupStep.WAITING_COUNT_CYCLES)) {</span>
<span class="fc" id="L304">            state.setSessionsBeforeLongBreak(value);</span>
<span class="fc" id="L305">            state.setStep(SetupStep.READY);</span>

<span class="fc" id="L307">            PomodoroServiceSettings settings = new PomodoroServiceSettings(</span>
<span class="fc" id="L308">                    state.getWorkDuration(),</span>
<span class="fc" id="L309">                    state.getShortRestDuration(),</span>
<span class="fc" id="L310">                    state.getLongRestDuration(),</span>
<span class="fc" id="L311">                    state.getSessionsBeforeLongBreak());</span>
<span class="fc" id="L312">            textAnswer = &quot;–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏–∫–ª–æ–≤ —Ä–∞–±–æ—Ç—ã –¥–æ –¥–ª–∏–Ω–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å! \n–û–∂–∏–¥–∞—é –∫–æ–º–∞–Ω–¥—É \&quot;–°—Ç–∞—Ä—Ç \uD83D\uDE80\&quot;!&quot;;</span>
<span class="fc" id="L313">            pomodoroManager.setSettings(chatId, settings);</span>
<span class="fc" id="L314">            pomodoroManager.addSession(</span>
                    chatId,
<span class="fc" id="L316">                    new PomodoroSession(Phase.WORK, pomodoroManager.getSettings(chatId).workDuration()));</span>
<span class="fc" id="L317">            pomodoroManager.getSession(chatId).setState(SessionState.WAITING);</span>
        }
<span class="fc" id="L319">        return new PomodoroReply(textAnswer, null, false);</span>
    }

    /**
     * –§–æ—Ä–º–∏—Ä—É–µ—Ç –∑–∞–≤–µ—Ä—à–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å–µ—Å—Å–∏–∏
     */
    public void closingMessage(StringBuilder builder, Long chatId) {
<span class="fc" id="L326">        PomodoroSession session = pomodoroManager.getSession(chatId);</span>
<span class="fc" id="L327">        String rank = pomodoroManager.calculateRank(session);</span>


<span class="fc" id="L330">        builder.append(&quot;–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. ‚úÖ&quot;)</span>
<span class="fc" id="L331">                .append(&quot;\n–°–æ–≤–µ—Ä—à–µ–Ω–æ —Ä–∞–±–æ—á–∏—Ö —Ü–∏–∫–ª–æ–≤: &quot;)</span>
<span class="fc" id="L332">                .append(session.getCompleteWorkingCycles())</span>
<span class="fc" id="L333">                .append(&quot; üíº&quot;)</span>
<span class="fc" id="L334">                .append(&quot;\n–í–∞–º –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –∑–≤–∞–Ω–∏–µ&quot;)</span>
<span class="fc" id="L335">                .append(&quot; &gt; &quot;)</span>
<span class="fc" id="L336">                .append(rank)</span>
<span class="fc" id="L337">                .append(&quot;&lt; &quot;)</span>
<span class="fc" id="L338">                .append(&quot;\uD83C\uDFC5&quot;);</span>
<span class="fc" id="L339">    }</span>

    private void logCurrentPhase(Long chatId, PomodoroServiceSettings settings) {
<span class="nc" id="L342">        Phase currentPhase = pomodoroManager.getSession(chatId).getCurrentPhase();</span>
<span class="nc bnc" id="L343" title="All 3 branches missed.">        Duration currentDuration = switch (currentPhase) {</span>
<span class="nc" id="L344">            case WORK -&gt; settings.workDuration();</span>
<span class="nc" id="L345">            case SHORT_BREAK -&gt; settings.shortRestDuration();</span>
<span class="nc" id="L346">            case LONG_BREAK -&gt; settings.longRestDuration();</span>
        };
<span class="nc" id="L348">        statsLogger.logPhase(chatId, currentPhase, currentDuration, Instant.now());</span>
<span class="nc" id="L349">    }</span>

    public boolean hasSession(Long chatId) {
<span class="fc" id="L352">        return pomodoroManager.hasActiveSession(chatId);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>